# ================================================================================================
#  workshop
#  Copyright (C) 2022 Tim Leonard
# ================================================================================================
type: shader
version: 1

# This effect takes the tiled lighting and gbuffer and builds a light accumulation buffer.
# Which is then used to apply lighting to the final image in a later step.

imports: [ data:shaders/common.yaml ]

effects:
  resolve_lighting:
    techniques:
      resolve_lighting: {}

param_blocks:
  resolve_lighting_parameters:
    scope: draw
    fields:
      light_count: int
      light_buffer: byteaddressbuffer
      #shadow_map_count: int
      #shadow_map_buffer: byteaddressbuffer
      view_world_position: float3
  light_state:
    scope: instance
    fields:
      type: int
      position: float3
      direction: float3
      color: float3
      intensity: float
      inner_radius: float
      outer_radius: float
      range: float
#      shadow_map_start_index: int
#      shadow_map_count: int
#  shadow_map_state:
#    scope: instance
#    fields:
#      light_matrix: matrix4
#      depth_map: texture2d

techniques:
  resolve_lighting:
    vertex_shader: 
      file: data:shaders/source/fullscreen_pass.hlsl
      entry: fullscreen_vshader
    pixel_shader: 
      file: data:shaders/source/resolve_lighting.hlsl
      entry: pshader
    render_state: no_depth_test
    vertex_layout: vertex2d_pos_uv
    output_target: light_buffer
    param_blocks: [ light_state, gbuffer, resolve_lighting_parameters ]
